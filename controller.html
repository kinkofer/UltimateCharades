<html>
    <head>
        <script type="text/javascript" src="https://www.airconsole.com/api/airconsole-1.7.0.js"></script>
        <script type="text/javascript" src="airconsole-view-manager.js"></script>
        <script type="text/javascript" src="airconsole-events.js"></script>
        <script type="text/javascript" src="airconsole-keyboard.js"></script>
        <script type="text/javascript" src="model.js"></script>
        <script type="text/javascript" src="jquery-3.5.0.min.js"></script>

        <link rel="stylesheet" type="text/css" href="style.css" />
        <link rel="stylesheet" type="text/css" href="airconsole-keyboard.css" />

        <style>
            body { color: whitesmoke; }

            #playerDiv { 
                vertical-align: middle;
                font-size: xx-large;
                padding: 10px;
            }

            .textfield {
                display: inline-block;
                border: 1px solid #888888;
                width: 200px;
                padding: 4px;
                min-height: 18px;
            }

            .errorMessage {
                font-style: italic;
                color: seagreen;
            }
        </style>
    </head>
    <body onload="init()">
        <div id="top" style="padding-top: 10px;"></div>


        <div id="PlayerStart" class="view default-view">
            <div class="playerDiv">
                <img src="" class="playerImage" />
                <span class="playerNickname"></span>
            </div>
            <div id="teamDiv" class="noTeam">
                <h1>Choose your team</h1>
                <button id="redTeamBtn">Red</button>
                <button id="blueTeamBtn">Blue</button>
            </div>
            <div>
                <h1>Enter your phrases:</h1>
                <div class="textfield" id="phraseTxt">
                    <div style="color:#aaa"><i>ex. A bird in the hand is worth two in the bush</i></div>
                </div>
                <button id="phraseBtn">Submit</button>
                <p>
                    <span>Phrases submitted:</span>
                    <span id="phrasesSubmittedLbl">0</span>
                </p>
                <p id="phraseMaxError" class="errorMessage" style="display: none;">You have already submitted the maximum.</p>
            </div>
            <div id="readyDiv">
                <h1>Ready to start?</h1>
                <p id="readyTeamError" class="errorMessage" style="display: none;">Choose a team first</p>
                <p id="readyPhrasesError" class="errorMessage" style="display: none;">Submit at least 3 phrases</p>
                <button id="readyBtn">Ready</button>
            </div>
            <div id="keyboard"></div>
        </div>


        <div id="Game" class="view">
            <div class="playerDiv">
                <img src="" class="playerImage" />
                <span class="playerNickname"></span>
            </div>
            <div id="gameRoundDiv">
                <div id="roundOneDiv">
                    <h1>Round One</h1>
                    <p>Rule: Speaking only</p>
                </div>
                <div id="roundTwoDiv" style="display: none;">
                    <h1>Round Two</h1>
                    <p>Rule: Charades, no speaking</p>
                </div>
                <div id="roundThreeDiv" style="display: none;">
                    <h1>Round One</h1>
                    <p>Rule: One word clues</p>
                </div>
            </div>
            <div id="waitingTurnDiv">
                <button id="startTurnBtn">It's my turn</button>
                <button id="cancelTurnBtn" style="display: none;">Cancel turn</button>
                <p id="startTurnError" class="errorMessage" style="display: none;">Someone else is taking their turn</p>
            </div>
            <div id="takingTurnDiv" style="display: none;">
                <button id="startClueGivingBtn">Start clue giving</button>
                <button id="endTurnBtn" style="display: none;">End turn</button>
                <div id="phrasesDiv">
                    <p id="phrase"></p>
                    <button id="correctBtn">Correct</button>
                    <button id="passBtn">Pass</button>
                </div>
            </div>
            <div id="guessingDiv" style="display: none;">
                <p>You are guessing</p>
            </div>
            <div id="endingRoundDiv" style="display: none;">
                <p>This round has ended. Check the score of the screen.</p>
            </div>
        </div>




        <div id="GameOver" class="view">
            <h1>Game Over</h1>
            <div id="finalScoreDiv">
                <h2>Final Score</h2>
            </div>
        </div>


        
        <script type="text/javascript">
            var airconsole;
            var viewManager = null;
            var keyboard;

            var player;
            var phrasesSubmitted = 0;

            var charades = [];

            var minPhrases = 3;
            var maxPhrases = 3;


            function init() {
                airconsole = new AirConsole();

                keyboard = new AirConsoleKeyboard("keyboard");
                keyboard.bind("phraseTxt");


                $('#redTeamBtn').click(_ => setPlayerTeam(Team.RED));
                $('#blueTeamBtn').click(_ => setPlayerTeam(Team.BLUE));

                $('#readyBtn').click(readyPlayer);

                $('#phraseBtn').click(sendPhrase);


                airconsole.onReady = function(code) {
                    viewManager = new AirConsoleViewManager(airconsole);

                    var device_id = airconsole.getDeviceId();
                    var profilePicture = airconsole.getProfilePicture(device_id);
                    var nickname = airconsole.getNickname(device_id);

                    player = new Player(device_id, profilePicture, nickname);
                    updatePlayerDiv();
                };


                airconsole.onDeviceStateChange = function(device_id, user_data) {
                    if (device_id == player.device_id) {
                        player.profilePicture = airconsole.getProfilePicture(device_id);
                        player.nickname = airconsole.getNickname(device_id);

                        updatePlayerDiv();
                    }
                };


                airconsole.onCustomDeviceStateChange = function(device_id, data) {
                    if (device_id == AirConsole.SCREEN) {
                        if (data.round != Round.NONE) {
                            updateGame();
                        }
                    }

                    viewManager.onViewChange(data, function(view_id) {
                        
                    });
                };


                airconsole.onMessage = function(device_id, data) {
                    this.dispatchEvent(device_id, data);
                };


                airconsole.on(UCEvent.SEND_CHARADES, function(device_id, data, context) {
                    charades = data;
                });
            }

            
            // - Player Start

            function setPlayerTeam(team) {
                player.team = team;
                airconsole.setCustomDeviceStateProperty("team", team);
                changeElementToTeamColor($("#teamDiv").get(0), team);
                $('#readyTeamError').hide();
            }


            function updatePlayerDiv() {
                $(".playerImage").attr("src", player.profilePicture);
                $(".playerNickname").html(player.nickname);
            }


            function readyPlayer() {
                // Check player team
                if (player.team == Team.NONE) {
                    $('#readyTeamError').show();
                    return;
                }
                else {
                    $('#readyTeamError').hide();
                }

                // Check submitted phrases
                if (!(phrasesSubmitted >= minPhrases)) {
                    $('#readyPhrasesError').show();
                    return;
                }
                else {
                    $('#readyPhrasesError').hide();
                    $('#phraseMaxError').hide();
                }

                // Set state
                if (player.state != PlayerState.READY) {
                    player.state = PlayerState.READY;
                    airconsole.setCustomDeviceStateProperty("state", PlayerState.READY);
                    
                    $('#readyDiv').find("h1").html("Waiting for other players");
                    $('#readyDiv').find("button").html("Cancel");

                    // TODO: Disable team selection and phrases
                }
                else {
                    // Player canceled
                    player.state = PlayerState.NOT_READY;
                    airconsole.setCustomDeviceStateProperty("state", PlayerState.NOT_READY);
                    
                    $('#readyDiv').find("h1").html("Ready to start?");
                    $('#readyDiv').find("button").html("Ready");

                    // TODO: Enable team selection and phrases
                }
            }


            // - Game

            function updateGame() {
                var screen = airconsole.getCustomDeviceState(AirConsole.SCREEN);
                (screen.round == Round.ONE) ? $('#roundOneDiv').show() : $('#roundOneDiv').hide();
                (screen.round == Round.TWO) ? $('#roundTwoDiv').show() : $('#roundTwoDiv').hide();
                (screen.round == Round.THREE) ? $('#roundThreeDiv').show() : $('#roundThreeDiv').hide();


            }

            // For testing only
            function showPhrases() {
                var phrases = charades.map(e => e.phrase);

                if (phrases.length == 0) { return; }
                
                var ul = $("<ul></ul>");
                ul.appendTo('#phrasesDiv');

                var listItems = phrases.map(e => "<li>" + e + "</li>");
                
                ul.append( listItems.join( "" ) );
            }


            // - Actions

            function sendPhrase() {
                if (phrasesSubmitted == maxPhrases) {
                    $('#phraseMaxError').show();
                    return;
                }
                else {
                    $('#phraseMaxError').hide();
                }

                let phrase = keyboard.valueText('phraseTxt');

                if (phrase == "") { return; }

                airconsole.sendEvent(AirConsole.SCREEN, UCEvent.SEND_PHRASE, { "phrase": phrase });

                phrasesSubmitted++;
                $('#phrasesSubmittedLbl').html(phrasesSubmitted);

                keyboard.setValue("phraseTxt", "");

                // TODO: Implement phrase editing
            }
        </script>
    </body>
</html>