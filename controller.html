<html>
    <head>
        <script type="text/javascript" src="https://www.airconsole.com/api/airconsole-1.7.0.js"></script>
        <script type="text/javascript" src="airconsole-view-manager.js"></script>
        <script type="text/javascript" src="airconsole-events.js"></script>
        <script type="text/javascript" src="utilities.js"></script>
        <script type="text/javascript" src="model.js"></script>
        <script type="text/javascript" src="jquery-3.5.0.min.js"></script>

        <link rel="stylesheet" type="text/css" href="style.css" />

        <style>
            body { color: whitesmoke; }

            h1 { 
                text-align: center;
                font-size: x-large;
            }

            #playerDiv { 
                vertical-align: middle;
                font-size: xx-large;
                padding: 10px;
            }

            #PlayerStart, #Game, #TakingTurn, #Guessing, #EndingRound, #GameOver { text-align: center; }

            #redTeamBtn, #blueTeamBtn {
                display: inline-block;
                color: whitesmoke;
                border: solid 1px whitesmoke;
                text-align: center;
                font-size: 20px;
                width: 40%;
                height: 50px;
                margin: -10px 10px 10px 10px;
            }

            #readyBtn, #cancelReadyBtn, #startBtn, 
            #startNextRoundBtn, #restartBtn {
                color: whitesmoke;
                border: solid 1px whitesmoke;
                text-align: center;
                font-size: 20px;
                width: 40%;
                height: 50px;
            }

            #startTurnBtn {
                height: 60%;
                width: 90%;
                font-size: xx-large;
            }

            #startClueGivingBtn, #correctBtn {
                height: 40%;
                width: 90%;
                font-size: xx-large;
            }

            #cancelTurnBtn, #endTurnBtn {
                background-color: gray;
                height: 20%;
                width: 90%;
                font-size: xx-large;
            }

            #phrase {
                font-size: xx-large;
            }

            .textfield {
                display: inline-block;
                border: 1px solid #888888;
                width: 200px;
                padding: 4px;
                min-height: 18px;
            }

            .errorMessage {
                font-style: italic;
                color: seagreen;
            }
        </style>
    </head>
    <body onload="init()">
        <div id="top" style="padding-top: 10px;"></div>


        <div id="PlayerStart" class="view default-view">
            <div id="teamDiv" class="noTeam">
                <h1>Choose your team</h1>
                <button id="redTeamBtn" class="redTeam">Red</button>
                <button id="blueTeamBtn" class="blueTeam">Blue</button>
            </div>
            <div id="phraseDiv">
                <h1>Enter your phrases:</h1>
                <input type="text" id="phraseTxt" placeholder="ex. A bird in the hand is worth two in the bush" />
                <button id="phraseBtn">Submit</button>
                <p>
                    <span>Phrases submitted:</span>
                    <span id="phrasesSubmittedLbl">0</span>
                </p>
                <p id="phraseMaxError" class="errorMessage" style="display: none;">You have already submitted the maximum.</p>
            </div>
            <div id="readyDiv">
                <h1>Ready to start?</h1>
                <p id="readyTeamError" class="errorMessage" style="display: none;">Choose a team first</p>
                <p id="readyPhrasesError" class="errorMessage" style="display: none;">Submit at least 3 phrases</p>
                <button id="readyBtn">Ready</button>
            </div>
            <div id="cancelReadyDiv" style="display: none;">
                <h1>Waiting for other players</h1>
                <button id="cancelReadyBtn">Cancel</button>
            </div>
            <div id="captainReadyDiv" style="display: none;">
                <h2>Everyone is ready!</h2>
                <button id="startBtn">Start Game</button>
            </div>
        </div>


        <div id="Game" class="view">
            <div id="waitingTurnDiv">
                <button id="startTurnBtn" class="noTeam">It's my turn</button>
                <p id="startTurnError" class="errorMessage" style="display: none;">Someone else is taking their turn</p>
            </div>
        </div>



        <div id="TakingTurn" class="view">
            <div id="confirmTakingTurnDiv">
                <p>Press start when the time keeper tells you.</p>
                <button id="startClueGivingBtn" class="noTeam">Start clue giving</button>
                <button id="cancelTurnBtn">Cancel turn</button>
            </div>
            <div id="takingTurnDiv" style="display: none;">
                <button id="endTurnBtn">End turn</button>
                <div id="phrasesDiv">
                    <p id="phrase"></p>
                    <button id="correctBtn">Correct</button>
                    <button id="passBtn" style="display: none;">Pass</button>
                </div>
            </div>
        </div>


        <div id="Guessing" class="view">
            <div id="guessingDiv">
                <p id="isGuessingLbl">You are guessing.</p>
                <p id="notGuessingLbl">The other team is guessing.</p>
            </div>
        </div>


        <div id="EndingRound" class="view">
            <div id="endingRoundDiv">
                <p>This round has ended. Check the score on the screen.</p>
            </div>
            <div id="captainEndingRoundDiv" style="display: none;">
                <p>Ready to start the next round?</p>
                <button id="startNextRoundBtn">Start Round</button>
            </div>
        </div>


        <div id="GameOver" class="view">
            <h1>Game Over</h1>
            <div id="captainGameOverDiv" style="display: none;">
                <p>Play Again?</p>
                <button id="restartBtn">Let's Play!</button>
            </div>
        </div>



        <div id="playerDivTemplate" style="display: none;">
            <img src="" class="playerImage" width="32" height="32" />
            <span class="captainLbl" style="display: none;">Captain </span>
            <span class="playerNickname"></span>
        </div>

        <div id="gameRoundDivTemplate" style="display: none;">
            <div class="roundOneDiv">
                <h2>Round One</h2>
                <h3>Rule: Speaking only</h3>
            </div>
            <div class="roundTwoDiv" style="display: none;">
                <h2>Round Two</h2>
                <h3>Rule: Charades, no speaking</h3>
            </div>
            <div class="roundThreeDiv" style="display: none;">
                <h2>Round Three</h2>
                <h3>Rule: One word clues</h3>
            </div>
        </div>


        

        <script type="text/javascript">
            var airconsole;
            var viewManager = null;

            var player;
            var phrasesSubmitted = 0;

            var charades = [];
            var currentCharade = null;

            var minPhrases = 3;
            var maxPhrases = 3;

            var takingTurnDeviceID = null;


            function init() {
                airconsole = new AirConsole();

                $('#redTeamBtn').click(_ => setPlayerTeam(Team.RED));
                $('#blueTeamBtn').click(_ => setPlayerTeam(Team.BLUE));

                $('#readyBtn').click(readyPlayer);
                $('#cancelReadyBtn').click(readyPlayer);

                $('#startBtn').click(_ => airconsole.sendEvent(AirConsole.SCREEN, UCEvent.START_GAME, null));

                $('#phraseBtn').click(sendPhrase);

                $('#startTurnBtn').click(_ => setPlayerState(PlayerState.TAKING_TURN));

                $('#startClueGivingBtn').click(startTurn);
                $('#cancelTurnBtn').click(_ => setPlayerState(PlayerState.WAITING_TURN));

                $('#endTurnBtn').click(endTurn);
                $('#correctBtn').click(guessCurrentPhrase);

                $('#startNextRoundBtn').click(_ => airconsole.sendEvent(AirConsole.SCREEN, UCEvent.START_NEXT_ROUND, null));
                $('#restartBtn').click(_ => airconsole.sendEvent(AirConsole.SCREEN, UCEvent.START_NEW_GAME, null));


                // Prepend Game Round and Rule to game Views
                var gameRoundDiv = $('#gameRoundDivTemplate').clone().show();
                gameRoundDiv.attr({ 'id': "", 'class': "gameRoundDiv"});
                $('#Game, #TakingTurn, #Guessing, #EndingRound').prepend(gameRoundDiv);

                // Prepend playerDiv to all Views
                var playerDiv = $('#playerDivTemplate').clone().show();
                playerDiv.attr({ 'id': "", 'class': "playerDiv"});
                $('.view').prepend(playerDiv);


                airconsole.onReady = function(code) {
                    viewManager = new AirConsoleViewManager(airconsole);

                    var device_id = airconsole.getDeviceId();
                    var profilePicture = airconsole.getProfilePicture(device_id);
                    var nickname = airconsole.getNickname(device_id);

                    player = new Player(device_id, profilePicture, nickname);
                    updatePlayerDiv();
                };


                airconsole.onActivePlayersChange = function(player_number) {
                    if (player_number == 0 &&
                        !player.isCaptain) {
                        setCaptain(true);
                    }
                }


                airconsole.onDeviceStateChange = function(device_id, user_data) {
                    if (device_id == player.device_id) {
                        player.profilePicture = airconsole.getProfilePicture(device_id);
                        player.nickname = airconsole.getNickname(device_id);

                        updatePlayerDiv();
                    }
                };


                airconsole.onCustomDeviceStateChange = function(device_id, data) {
                    if (device_id == AirConsole.SCREEN) {
                        if (data.round != Round.NONE) {
                            updateGame();
                        }

                        if (player.isCaptain) {
                            if (data.state == ScreenState.NEW) { 
                                $('#captainReadyDiv').hide();
                                $('#captainGameOverDiv').hide();
                            }
                            else if (data.state == ScreenState.READY) { $('#captainReadyDiv').show(); }
                            else if (data.state == ScreenState.ENDING_ROUND) { $('#captainEndingRoundDiv').show(); }
                            else if (data.state == ScreenState.WAITING_TURN) { $('#captainEndingRoundDiv').hide(); }
                            else if (data.state == ScreenState.GAME_OVER) { $('#captainGameOverDiv').show(); }
                        }

                        if (player.state == PlayerState.READY &&
                            data.state == ScreenState.WAITING_TURN) {
                            // Start game
                            setPlayerState(PlayerState.WAITING_TURN);
                        }
                        else if (player.state == PlayerState.WAITING_FOR_NEXT_ROUND &&
                            data.state == ScreenState.WAITING_TURN) {
                            // Next round
                            setPlayerState(PlayerState.WAITING_TURN);
                        }
                        else if (player.state == PlayerState.GAME_OVER &&
                            data.state == ScreenState.NEW) {
                            // New game
                            setPlayerState(PlayerState.NONE);
                        }
                    }
                    else if ("state" in data) {
                        playerDidChangeState(device_id, data.state);
                    }
                    else if ("isCaptain" in data && data.isCaptain == true) {
                        setCaptain(false)
                    }

                    viewManager.onViewChange(data, function(view_id) { });
                };


                airconsole.onMessage = function(device_id, data) {
                    this.dispatchEvent(device_id, data);
                };


                airconsole.on(UCEvent.SEND_CHARADES, function(device_id, data, context) {
                    charades = data;
                });
            }


            function resetGame() {
                phrasesSubmitted = 0;
                $('#phrasesSubmittedLbl').html("0");
                charades.length = 0;
            }

            
            // - Player Start

            function setPlayerTeam(team) {
                player.team = team;
                airconsole.setCustomDeviceStateProperty("team", team);
                changeElementToTeamColor($("#teamDiv").get(0), team);
                $('#readyTeamError').hide();
            }


            function setCaptain(isCaptain) {
                player.isCaptain = isCaptain;
                airconsole.setCustomDeviceStateProperty("isCaptain", isCaptain);
                isCaptain ? $('.captainLbl').show() : $('.captainLbl').hide();
            }


            function updatePlayerDiv() {
                $(".playerImage").attr("src", player.profilePicture);
                $(".playerNickname").html(player.nickname);
            }


            function readyPlayer() {
                // Check player team
                if (player.team == Team.NONE) {
                    $('#readyTeamError').show();
                    return;
                }
                else {
                    $('#readyTeamError').hide();
                }

                // Check submitted phrases
                if (!(phrasesSubmitted >= minPhrases)) {
                    $('#readyPhrasesError').show();
                    return;
                }
                else {
                    $('#readyPhrasesError').hide();
                    $('#phraseMaxError').hide();
                }

                // Set state
                if (player.state != PlayerState.READY) {
                    setPlayerState(PlayerState.READY);
                }
                else {
                    // Player canceled
                    setPlayerState(PlayerState.NOT_READY);
                }
            }


            function setPlayerState(newState) {
                var oldState = player.state;
                player.state = newState;
                airconsole.setCustomDeviceStateProperty("state", newState);

                switch (newState) {
                    case PlayerState.NONE:
                        // New game
                        resetGame();
                        viewManager.show('PlayerStart');

                        $('#readyDiv').show();
                        $('#cancelReadyDiv').hide();
                        break;
                    case PlayerState.READY:
                        $('#readyDiv').hide();
                        $('#cancelReadyDiv').show();

                        // TODO: Disable team selection and phrases
                        break;
                    case PlayerState.NOT_READY:
                        $('#readyDiv').show();
                        $('#cancelReadyDiv').hide();

                        // TODO: Enable team selection and phrases
                        break;
                    case PlayerState.WAITING_TURN:
                        $('#confirmTakingTurnDiv').show();
                        $('#takingTurnDiv').hide();
                        changeElementToTeamColor($('#startTurnBtn').get(0), player.team);
                        viewManager.show("Game");
                            
                        updateGame();
                        break;
                    case PlayerState.TAKING_TURN:
                        changeElementToTeamColor($('#startClueGivingBtn').get(0), player.team);
                        viewManager.show("TakingTurn");
                        break;
                    case PlayerState.GUESSING:
                        var guessingTeam = airconsole.getCustomDeviceState(takingTurnDeviceID).team;
                        (player.team == guessingTeam) ? $('#isGuessingLbl').show() : $('#isGuessingLbl').hide();
                        (player.team != guessingTeam) ? $('#notGuessingLbl').show() : $('#notGuessingLbl').hide();

                        viewManager.show("Guessing");
                        break;
                    case PlayerState.WAITING_FOR_NEXT_ROUND:
                        viewManager.show("EndingRound");
                        updateGame();
                        break;
                    case PlayerState.GAME_OVER:
                        viewManager.show("GameOver");
                        break;
                }
            }


            function playerDidChangeState(device_id, state) {
                if (state == PlayerState.TAKING_TURN) {
                    takingTurnDeviceID = device_id;
                    setPlayerState(PlayerState.GUESSING);
                }
                else if (takingTurnDeviceID != null &&
                    takingTurnDeviceID == device_id &&
                    state == PlayerState.WAITING_TURN) {
                    // Other player is finished taking their turn
                    takingTurnDeviceID = null;
                    setPlayerState(PlayerState.WAITING_TURN);
                }
                else if (state == PlayerState.WAITING_FOR_NEXT_ROUND) {
                    // Other player finished the round
                    takingTurnDeviceID = null;
                    setPlayerState(PlayerState.WAITING_FOR_NEXT_ROUND);
                }
                else if (state == PlayerState.GAME_OVER) {
                    // Other player ended the game
                    takingTurnDeviceID = null;
                    setPlayerState(PlayerState.GAME_OVER);
                }
            }


            // - Game

            function updateGame() {
                var screen = airconsole.getCustomDeviceState(AirConsole.SCREEN);

                // gameRoundDiv
                (screen.round == Round.ONE) ? $('.roundOneDiv').show() : $('.roundOneDiv').hide();
                (screen.round == Round.TWO) ? $('.roundTwoDiv').show() : $('.roundTwoDiv').hide();
                (screen.round == Round.THREE) ? $('.roundThreeDiv').show() : $('.roundThreeDiv').hide();
            }


            function startTurn() {
                $('#confirmTakingTurnDiv').hide();
                $('#takingTurnDiv').show();

                charades = shuffle(charades);

                showNextPhrase();
            }


            function guessCurrentPhrase() {
                currentCharade.state = CharadeState.GUESSED;
                currentCharade.team = player.team;
                showNextPhrase();
            }


            function showNextPhrase() {
                let unguessedCharades = charades.filter(e => e.state == CharadeState.NEW);

                if (unguessedCharades.length == 0) {
                    endRound();
                }
                else {
                    currentCharade = unguessedCharades[0];
                    $('#phrase').html(currentCharade.phrase);
                }
            }


            function endTurn() {
                currentCharade = null;
                $('#phrase').html("");

                // Send results
                airconsole.broadcastEvent(UCEvent.SEND_CHARADES, charades);

                // Back to player turn select
                setPlayerState(PlayerState.WAITING_TURN);
            }


            function endRound() {
                currentCharade = null;
                $('#phrase').html("");

                // Send results
                airconsole.broadcastEvent(UCEvent.SEND_CHARADES, charades);

                // Check for end game
                var screen = airconsole.getCustomDeviceState(AirConsole.SCREEN);
                if (screen.round != Round.THREE) {
                    setPlayerState(PlayerState.WAITING_FOR_NEXT_ROUND);
                }
                else {
                    endGame();
                }
            }


            function endGame() {
                setPlayerState(PlayerState.GAME_OVER);
            }


            // - Actions

            function sendPhrase() {
                if (phrasesSubmitted == maxPhrases) {
                    $('#phraseMaxError').show();
                    return;
                }
                else {
                    $('#phraseMaxError').hide();
                }

                let phrase = $('#phraseTxt').val();

                if (phrase == "") { return; }

                airconsole.sendEvent(AirConsole.SCREEN, UCEvent.SEND_PHRASE, { "phrase": phrase });

                phrasesSubmitted++;
                $('#phrasesSubmittedLbl').html(phrasesSubmitted);

                $('#phraseTxt').val("");

                // TODO: Implement phrase editing
            }
        </script>
    </body>
</html>